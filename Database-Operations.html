<!doctype html>
<html>
 <head> 
  <title>ATS : Database Operations</title> 
  <link rel="stylesheet" href="styles/site.css" type="text/css"> 
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> 
 </head> 
 <body class="theme-default aui-theme-default"> 
  <div id="page"> 
   <div id="main" class="aui-page-panel"> 
    <div id="main-header"> 
     <a><img class="axway_logo" src="images/AxwayLogo.png" alt="Axway Inc"></a> 
     <div id="breadcrumb-section"> 
      <ol id="breadcrumbs"> 
       <li class="first"> <span><a href="index.html">ATS</a></span> </li> 
       <li> <span><a href="ATS-Documentation.html">ATS Documentation</a></span> </li> 
       <li> <span><a href="ATS-Guide.html">ATS Guide</a></span> </li> 
       <li> <span><a href="Basic-functionalities.html">Basic functionalities</a></span> </li> 
      </ol> 
     </div> 
     <h1 id="title-heading" class="pagetitle"> <span id="title-text"> ATS : Database Operations </span> </h1> 
    </div> 
    <div id="content" class="view"> 
     <div id="main-content" class="wiki-content group"> 
      <h1 id="DatabaseOperations-Introduction">Introduction</h1> 
      <p>Currently ATS supports <em>Oracle Database, MySQL, Microsoft SQL</em> Server, <em>PostgreSQL</em> and <em>Cassandra</em>. With some effort, It is also possible to plug-in support for your own database type.</p> 
      <p><br></p> 
      <hr> 
      <h1 id="DatabaseOperations-Basicexample">Basic example</h1> 
      <p>Here is some example code:</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">    import com.axway.ats.action.dbaccess.DatabaseOperations;
    import com.axway.ats.action.dbaccess.model.DatabaseCell;
    import com.axway.ats.action.dbaccess.model.DatabaseRow;
    import com.axway.ats.harness.config.TestBox;

    @Test
    public void databaseOperations() {

        TestBox serverBox = new TestBox();
        serverBox.setHost( SERVER_IP );
        serverBox.setDbType( "MSSQL" );
        serverBox.setDbName( "DemoDatabase" );
        serverBox.setDbUser( USER_NAME );
        serverBox.setDbPass( USER_PASSWORD );

        // Make an instance of this class by providing the connection parameters
        DatabaseOperations dbOperations = new DatabaseOperations( serverBox );

        // fetch value from the DB
        String dbValue1 = dbOperations.getValue( "Table1", "column1", "id", "1" );
        log.info( "We fetched this db value: " + dbValue1 );

        // the next command will produce same result
        String dbValue2 = dbOperations.getValue( "SELECT column1 FROM Table1 WHERE id = 1" );
        log.info( "We fetched this db value: " + dbValue2 );

        // delete rows from Table1 that match the provided where clause
        dbOperations.delete( "Table1", "column1='ABC'" );

        // update the value of column1 where column2 has some particular value
        dbOperations.updateValue( "Table1", "column1", "new value", "column2", "where_value" );

        /* 
         * when you extract not just a single value, but many rows and columns
         * it is convenient to use the next example which shows the usage
         * of very simple classes called DatabaseRow and DatabaseCell
         */
        DatabaseRow[] dbRows = dbOperations.getDatabaseData( "SELECT column1, column2 FROM Table1" );
        log.info( "Found " + dbRows.length + " DB rows" );
        for( DatabaseRow dbRow : dbRows ) {
            DatabaseCell column1Cell = dbRow.getCell( "column1" );
            DatabaseCell column2Cell = dbRow.getCell( "column2" );

            log.info( "column1 is " + column1Cell.getValue() + " while column2 is " + column2Cell.getValue() );
        }
    }</pre> 
       </div> 
      </div> 
      <p>Following are some specifics which are important when working with a particular database provider.</p> 
      <p><br></p> 
      <hr> 
      <h1 id="DatabaseOperations-ProvidingDBconnectionparameters">Providing DB connection parameters</h1> 
      <p>Describing the database to work with needs a lot of parameters:</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">// Create a TestBox object describing your DB connection parameters
TestBox dbBox = new TestBox();
dbBox.setDbType( "MYSQL" );
dbBox.setHost( SERVER_IP );
dbBox.setDbName( "DemoDatabase" );
dbBox.setDbUser( USER_NAME );
dbBox.setDbPass( USER_PASSWORD );
	
// Make an instance of this class by providing the connection parameters
DatabaseOperations dbOperations = new DatabaseOperations( dbBox );

// Now you can use its methods
</pre> 
       </div> 
      </div> 
      <p><br></p> 
      <hr> 
      <h1 id="DatabaseOperations-Setacustomportforanydatabasetype">Set a custom port for any database type</h1> 
      <p>If you do not specify a DB port, we will use the default one. Otherwise, here is how you can specify the right port number:</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">dbBox.setDbPort( "3310" );
</pre> 
       </div> 
      </div> 
      <p><br></p> 
      <hr> 
      <h1 id="DatabaseOperations-Addadditionalconnectionparameters">Add additional connection parameters</h1> 
      <p>You will see examples bellow with some more special configurations needed to work properly with a database. For such cases you can create a map which will contain data that will change the behavior of DatabaseOperations class.</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">import java.util.Map;
import java.util.HashMap;

// create a map for custom properties
Map&lt;String, Object&gt; customProperties = new HashMap&lt;&gt;();

// Make an instance of this class by providing the connection parameters and custom properties as well
DatabaseOperations dbOperations = new DatabaseOperations( dbBox, customProperties );</pre> 
       </div> 
      </div> 
      <p><br></p> 
      <hr> 
      <h1 id="DatabaseOperations-Useadmincredentials">Use admin credentials</h1> 
      <p>The TestBox class supports a DB user and password as well as Admin user and password. You set them by calling setDbUser, setDbPass,&nbsp;setAdminUser and setAdminPass.</p> 
      <p>By default when establishing connection the DatabaseOperations class will use the DB user and password. If you want to use the Admin user and password instead, then you need to add this custom property <em>DbKeys.USE_ADMIN_CREDENTIALS</em> with value "true"</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">import com.axway.ats.common.dbaccess.DbKeys;

customProperties.put( DbKeys.USE_ADMIN_CREDENTIALS, "true" );
</pre> 
       </div> 
      </div> 
      <p><br></p> 
      <hr> 
      <h1 id="DatabaseOperations-OracleDatabaseSpecifics">Oracle Database Specifics</h1> 
      <p>This section deals with some Oracle DB specifics</p> 
      <h3 id="DatabaseOperations-Connectionspecifics">Connection specifics</h3> 
      <p>When working with an Oracle DB, you often need to provide some extra parameters in order to connect successfully. These are the <em>SID</em> and <em>SERVICE NAME</em>.</p> 
      <p>You can do it by providing some custom values:</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">import com.axway.ats.common.dbaccess.OracleKeys;

// Specify a SID
customProperties.put( OracleKeys.SID_KEY, "MySid" );

// Specify a Service name
customProperties.put( OracleKeys.SERVICE_NAME_KEY, "MyServiceName" );
</pre> 
       </div> 
      </div> 
      <div class="confluence-information-macro has-no-icon confluence-information-macro-note"> 
       <div class="confluence-information-macro-body"> 
        <p>If you do not specify a <em> <strong>SID</strong> </em> value, we will use <strong> <em>ORCL</em> </strong></p> 
       </div> 
      </div> 
      <h3 id="DatabaseOperations-UsesecureconnectiontoOracleDatabase">Use secure connection to Oracle Database</h3> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">// Specify the following property with value "true" to use secure connection
customProperties.put(OracleKeys.USE_SECURE_SOCKET, "true");
 
// Specify keystore file full path, type and password
customProperties.put(OracleKeys.KEY_STORE_FULL_PATH, &lt;Keystore Full Path&gt; );
customProperties.put(OracleKeys.KEY_STORE_TYPE, &lt;Keystore Type&gt; );
customProperties.put(OracleKeys.KEY_STORE_PASSWORD, &lt;Keystore Password&gt; );
</pre> 
       </div> 
      </div> 
      <div class="confluence-information-macro has-no-icon confluence-information-macro-note"> 
       <div class="confluence-information-macro-body"> 
        <p>If you do not specify all keystore properties, we will create default ones</p> 
       </div> 
      </div> 
      <h3 id="DatabaseOperations-Obtainingcertificatesdirectlyfromthedatabaseconnection">Obtaining certificates directly from the database connection</h3> 
      <p>If needed, you can use the following to obtain the appropriate certificate from your Oracle database server, then save it into a file and use for achieving secure connectivity.</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">import com.axway.ats.action.security.CertificateUtilities;

// next line will cause establishing TLS connection and returning the needed certificates
Certificate[] cerrificates = CertificateUtilities.getSecurityCertificates( DB_HOST, DB_PORT );

// now you can save the right certificate into a file
CertificateUtilities.createKeyStoreFile( cerrificates[0], &lt;Keystore Full Path&gt;, &lt;Keystore Password&gt;, &lt;Keystore Type&gt; );

// and now you can establish secure connection using DatabaseOperations as shown in an upper section</pre> 
       </div> 
      </div> 
      <h3 id="DatabaseOperations-ProblemwithINSERTandUPDATEoflongbinarydata">Problem with INSERT and UPDATE of long binary data</h3> 
      <p>There is a common problem when trying to INSERT/UPDATE a long value in a binary column (BLOB, CLOB, ...) and the statement execution fails with an error like:</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">ORA-01704: string literal too long
Cause: The string literal is longer than 4000 characters.
Action: Use a string literal of at most 4000 characters. 
Longer values may only be entered using bind variables.
</pre> 
       </div> 
      </div> 
      <p>The workaround here is a block statement, where you have to assign the long value to a variable, defined with the same type as the column, and then use this variable in the INSERT/UPDATE statement:</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"> 
        <b>Example with updating long value in a BLOB column</b> 
       </div> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">DECLARE
  binValue myTable.blobColumn%type;
BEGIN
  binValue := to_blob('Some very long string value');
  UPDATE myTable SET blobColumn = binValue WHERE someKey = someCriteria;
END;
</pre> 
       </div> 
      </div> 
      <p><br></p> 
      <hr> 
      <h1 id="DatabaseOperations-MicrosoftSQLServerSpecifics">Microsoft SQL Server Specifics</h1> 
      <p>This section deals with some Microsoft SQL (or Ms SQL) database specifics.</p> 
      <h3 id="DatabaseOperations-SecureconnectionwithMsSQLdatabase">Secure connection with Ms SQL database</h3> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">// add this property to enable security connection 
customProperties.put( DbKeys.USE_SECURE_SOCKET, "true" );
</pre> 
       </div> 
      </div> 
      <p><br></p> 
      <h3 id="DatabaseOperations-UsedifferentJDBCdriverforSQLServer">Use different JDBC driver for SQL Server</h3> 
      <p>The Microsoft JDBC library must be present in the classpath. It could be retrieved from <a class="external-link" href="https://docs.microsoft.com/en-us/sql/connect/jdbc/overview-of-the-jdbc-driver" rel="nofollow">here</a>. And <a class="external-link" href="https://docs.microsoft.com/en-us/sql/connect/jdbc/download-microsoft-jdbc-driver-for-sql-server" rel="nofollow">there</a> are also instructions how to add the dependency via Maven.</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">// add this property to use the mssql-jdbc driver
System.setProperty( "com.axway.automation.ats.logdbdriver", "MSSQL" );</pre> 
       </div> 
      </div> 
      <p><br></p> 
      <div class="confluence-information-macro has-no-icon confluence-information-macro-note"> 
       <div class="confluence-information-macro-body"> 
        <p>Original version of JTDS has some issues with the SSL connection, so it is possible your connection to hang. Then you may search for unofficial patched version of JTDS or use SQL Server JDBC driver.</p> 
       </div> 
      </div> 
      <p><br></p> 
      <hr> 
      <h1 id="DatabaseOperations-CassandraSpecifics">Cassandra Specifics</h1> 
      <p>Apache <a class="external-link" href="http://cassandra.apache.org/" rel="nofollow">Cassandra</a> can give you different kind of errors you are not used with.</p> 
      <div class="confluence-information-macro confluence-information-macro-warning"> 
       <p class="title">Working with Cassandra DB</p> 
       <span class="aui-icon aui-icon-small aui-iconfont-error confluence-information-macro-icon"></span> 
       <div class="confluence-information-macro-body"> 
        <p>Java 8+ is required for working with Cassandra DB. This shouldn't be an issue because since version 4.0.7 the whole ATS framework requires Java 8.</p> 
       </div> 
      </div> 
      <h3 id="DatabaseOperations-Dependencies">Dependencies</h3> 
      <p>Currently ATS is using the following <a class="external-link" href="https://www.datastax.com/" rel="nofollow">Datastax</a> driver version to work with Cassandra DB:</p> 
      <p>But the ATS is not directly depending on the Datastax driver dependencies. So you have to add them to your classpath.</p> 
      <p>Here is how to do it with Maven</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">  &lt;dependency&gt;
    &lt;groupId&gt;com.datastax.cassandra&lt;/groupId&gt;
    &lt;artifactId&gt;cassandra-driver-core&lt;/artifactId&gt;
    &lt;version&gt;3.2.0&lt;/version&gt;
  &lt;/dependency&gt;
</pre> 
       </div> 
      </div> 
      <h3 id="DatabaseOperations-Cassandraspecificerrormessages">Cassandra specific error messages</h3> 
      <ul> 
       <li>"Cannot execute this query as it might involve data filtering and thus may have unpredictable performance. If you want to execute this query despite the performance unpredictability, use ALLOW FILTERING"<br>The solution is the add ALLOW FILTERING token at the end of the SQL query. The options are: 
        <ul> 
         <li><p>Add the following custom property and we will append the token after each SELECT query</p> 
          <div class="code panel pdl" style="border-width: 1px;"> 
           <div class="codeContent panelContent pdl"> 
            <pre class="syntaxhighlighter-pre" data-theme="Confluence">customProperties.put( "ALLOW FILTERING", true );
</pre> 
           </div> 
          </div></li> 
         <li>Add yourself the needed token</li> 
        </ul></li> 
       <li>"No indexed columns present in by-columns clause with Equal operator" - Change your <em>where</em> clause.</li> 
       <li>"Non PRIMARY KEY type found in where clause" - Change your <em>where</em> clause.</li> 
       <li>"Invalid STRING constant (a14f0f51-7ff2-43fe-b922-8c36ddbbd91f) for id of type uuid" - In the <em>where</em> clauses, some data types (like UUID) must not be quoted while others (like TEXT) must be quoted.</li> 
      </ul> 
      <p><br></p> 
      <hr> 
      <h1 id="DatabaseOperations-PostgreSQLSpecifics">PostgreSQL Specifics</h1> 
      <h2 id="DatabaseOperations-Namingconventions">Naming conventions</h2> 
      <p>By default, in SQL queries, PostgreSQL converts identifiers like table and column names to lower case. <br>In order to preserve the case of the letters for the identifiers, you must additionally enclose them in double quotes. So if the table name is Persons ( intentionally created case-sensitive) , then you should pass "Persons" in the query, in quotes. The guideline is to either always use lower case, or always use case-sensitive names enclosed in double quotes. <br>For more details you may check PostgreSQL documentation here: <a class="external-link" href="https://www.postgresql.org/docs/current/sql-syntax-lexical.html" rel="nofollow">https://www.postgresql.org/docs/current/sql-syntax-lexical.html</a>, Section 4.1.1. Identifiers and Key Words, last paragraph.</p> 
      <p><br></p> 
      <hr> 
      <h1 id="DatabaseOperations-MySQLSpecifics">MySQL Specifics</h1> 
      <h3 id="DatabaseOperations-JDBCdriversupport">JDBC driver support</h3> 
      <p>Starting with ATS version <strong>4.0.7</strong>, MySQL has support for at least two JDBC driver versions, namely 8.0.xx (currently is 8.0.21) and 5.1.xx (validated with 5.1.42). <br>This is done transparently to the user (regardless of the different classes used) by checking which version is available in the classpath. First is the check for 8.0.xx case, then, if no such dependency is found, for 5.1.xx.</p> 
      <p>Most of the time, you will not be able to differentiate which version is used, because both of them are supported equally and no difference in their behaviour was found.</p> 
      <p>The only change might be in the performance of the two drivers. This might be related only to PERFormance testing against MySQL servers.</p> 
      <h3 id="DatabaseOperations-Timezonesupport">Timezone support</h3> 
      <p>If you are using the <strong>8.xx.xx</strong> JDBC version, MySQL JDBC driver <strong>requires</strong> to know the timezone of the server it is connecting to. This leads to a situation where the returned timezone name is not <strong>IANA</strong> named, e.g. instead of <strong>Europe/Sofia</strong>, it is returned as <strong>EEST</strong> ( <strong>Eastert European Summer Time</strong> )</p> 
      <p>This causes the JVM to throw an exception about missing timezone or timezone name, that references more than one actual timezone.</p> 
      <p>ATS automatically tries to find the best possible match, but if some of your SQL types (Date, Timezone, etc) starts to look quirky, you can see the server time zone and set the appropriate value.</p> 
      <p>This is done by passing a custom property to the MySQL database connection. Here is a little example:</p> 
      <div class="code panel pdl" style="border-width: 1px;"> 
       <div class="codeHeader panelHeader pdl" style="border-bottom-width: 1px;"> 
        <b>Setting timezone for MySQL manually</b> 
       </div> 
       <div class="codeContent panelContent pdl"> 
        <pre class="syntaxhighlighter-pre" data-theme="Confluence">...
Map&lt;String, Object&gt; custProps = new HashMap&lt;String, Object&gt;();
custProps.put(DbKeys.SERVER_TIMEZONE, "GMT+2"); // UTC works only without offset, so if you want UTC-3 just replace UTC with GMT and you are good to go
// pass the custom properties where needed
...</pre> 
       </div> 
      </div> 
      <p>The symptoms of this type of problems are such logs (Warning and a possible exception after it):</p> 
      <blockquote> 
       <p>WARNING mysql.<u>DbConnMySQL: No server timezone specified. This can lead to an exception! </u></p> 
       <p>INFO&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mysql.DbConnMySQL: MySQL datasource class will be 'com.mysql.cj.jdbc.MysqlConnectionPoolDataSource'. Begin datasource configuration</p> 
       <p>ERROR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; EXCEPTION</p> 
       <p>&nbsp;&nbsp; USER message: axway.ats: [TestNG]: TEST FAILED</p> 
       <p>&nbsp;&nbsp; CALL STACK:com.axway.ats.action.exceptions.DatabaseOperationsException: Error getting value from DB with query xxxxx</p> 
       <p>&nbsp; at com.axway.ats.action.dbaccess.DatabaseOperations.getValue(DatabaseOperations.java:328)</p> 
       <p>&nbsp; ...</p> 
       <p>&nbsp; at org.testng.TestNG.runSuites(TestNG.java:1133)</p> 
       <p>&nbsp; ...</p> 
       <p>Caused by: com.axway.ats.core.dbaccess.exceptions.DbException: <u>Error while configuring MySQL's data source instance</u></p> 
       <p>&nbsp; at com.axway.ats.core.dbaccess.mysql.DbConnMySQL.createDataSource(DbConnMySQL.java:285)</p> 
       <p>&nbsp; at com.axway.ats.core.dbaccess.mysql.DbConnMySQL.getDataSource(DbConnMySQL.java:160)</p> 
       <p>&nbsp; at com.axway.ats.core.dbaccess.ConnectionPool.getConnection(ConnectionPool.java:66)</p> 
       <p>&nbsp; ...</p> 
       <p>Caused by: java.text.ParseException:<u> Unparseable date</u>: "00:00:00 FLE Standard Time 2020"</p> 
       <p>&nbsp; at java.base/java.text.DateFormat.parse(DateFormat.java:395)</p> 
       <p>&nbsp; at com.axway.ats.core.dbaccess.mysql.DbConnMySQL.createDataSource(DbConnMySQL.java:258)</p> 
       <p>&nbsp; ...</p> 
       <p>&nbsp; 34 more</p> 
      </blockquote> 
      <p><br></p> 
      <p><br></p> 
      <hr> 
      <p>Back to <a href="Basic-functionalities.html">parent page</a><p>Go to <a href="./toc.html">Table of Contents</a></p></p> 
      <hr> 
     </div> 
    </div> 
   </div> 
  </div>  
 </body>
</html>