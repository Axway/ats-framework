<!DOCTYPE html>
<html>
    <head>
        <title>ATS : Database Snapshots</title>
        <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">
    </head>

    <body class="theme-default aui-theme-default">
        <div id="page">
            <div id="main" class="aui-page-panel">
                <div id="main-header">
<a><img class="axway_logo" src="images/AxwayLogo.png" alt="Axway Inc"></a>

                    <div id="breadcrumb-section">
                        <ol id="breadcrumbs">
                            <li class="first">
                                <span><a href="index.html">ATS</a></span>
                            </li>
                                                    <li>
                                <span><a href="Axway-Automation-Framework-Home-Page.html">Axway Automation Framework Home Page</a></span>
                            </li>
                                                    <li>
                                <span><a href="ATS-Documentation.html">ATS Documentation</a></span>
                            </li>
                                                    <li>
                                <span><a href="ATS-Guide.html">ATS Guide</a></span>
                            </li>
                                                    <li>
                                <span><a href="Basic-functionalities.html">Basic functionalities</a></span>
                            </li>
                                                </ol>
                    </div>
                    <h1 id="title-heading" class="pagetitle">
                                                <span id="title-text">
                            ATS : Database Snapshots
                        </span>
                    </h1>
                </div>

                <div id="content" class="view">
                    <div class="page-metadata">
                        
        
    
        
    
        
        
            Created by <span class='author'> Nikolay Gogovski</span>, last modified on Mar 20, 2017
                        </div>
                    <div id="main-content" class="wiki-content group">
                    <h1 id="DatabaseSnapshots-Introduction">Introduction</h1><p>In some cases you might be interested to know what changes were made on some database.</p><p>The regular example is when you want to test whether an upgrade of your Application Under Test did not cause any unwanted changes on the database.</p><p> </p><hr/><h1 id="DatabaseSnapshots-Makesurethereisnochangeonthedatabase">Make sure there is no change on the database</h1><p>The following example makes a snapshot of two databases. An instance of TestBox is used to provide connection parameters to the databases.</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">import com.axway.ats.harness.config.TestBox;
import com.axway.ats.action.dbaccess.snapshot.DatabaseSnapshot;

// create a test box instance
TestBox testBox1 = new TestBox();
// and here use the different setter method in order to provide DB connection parameters
testBox1.set...

// make a snapshot from the database pointed in the test box
DatabaseSnapshot snapshot1 = new DatabaseSnapshot( &quot;snap1&quot;, testBox1 );
// take first snapshot
snapshot1.takeSnapshot();

// create another test box instance
TestBox testBox2 = new TestBox();
// and here use the different setter method in order to provide DB connection parameters
testBox2.set...

// make a second snapshot from the database pointed in the test box
DatabaseSnapshot snapshot2 = new DatabaseSnapshot( &quot;snap2&quot;, testBox2 );
// take second snapshot
snapshot2.takeSnapshot();

// compare both snapshots
snapshot2.compare( snapshot1 );
</pre>
</div></div><p>If the databases are identical a message will be logged. Otherwise the <em>compare</em> method will throw an error describing the found differences. For example:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">Comparing [snap2] and [snap1] produced the following unexpected differences:
Tables present in [snap2] only:
	Accounts
	Users
Different primary keys:
	table &#39;Transactions&#39;, primary key column in [snap2] is &#39;id&#39;, while in [snap1] is &#39;identification&#39;
Table indexes for &#39;Operations&#39; table:
	[snap2]:
		name=PRIMARY, column=id, index catalog=, type=BIT, asc/desc=A, non-unique=false, filter condition=null, sequence number=1
	[snap1]:
		name=PRIMARY, column=id, index catalog=, type=BINARY, asc/desc=A, non-unique=false, filter condition=null, sequence number=1
</pre>
</div></div><p>In the above description we see that:</p><ul><li>there are table that are present in just one of the snapshots</li><li>there is table with a different primary key column</li><li>there is a table which index has a different type</li></ul><p> </p><hr/><h1 id="DatabaseSnapshots-Whenisthedataloaded?">When is the data loaded?</h1><p>It is not clever to load all database data in the java memory as this might cause memory issues.</p><p>So when you call <em>takeSnapshot</em> method, we load only the list of tables and different meta information about each table like primary key, columns, indexes.</p><p>The real loading of the tables content is done when needed and this is:</p><ul><li>when called <em>compare</em> method, we load the content of one table at a time for both databases. After comparing a pair of tables, we load data about the next pair and so on.</li><li>when called <em>saveToFile</em> method. We load one table at a time, save it into a file and then proceed to the next table</li></ul><p> </p><hr/><h1 id="DatabaseSnapshots-Donotchecksometable">Do not check some table</h1><p>By default all found tables in the pointed databases are checked. If you want to exclude a table from the check, you can do:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">// skip one table
snapshot1.skipTables( &quot;SomeTable&quot; );

// skip some tables
snapshot1.skipTables( &quot;SomeTable1&quot;, &quot;SomeTable2&quot;, &quot;SomeTable3&quot; );
// or
snapshot1.skipTables( new String[]{ &quot;SomeTable1&quot;, &quot;SomeTable2&quot;, &quot;SomeTable3&quot;} );
</pre>
</div></div><p> </p><hr/><h1 id="DatabaseSnapshots-Donotchecksomecolumn(s)fromsometable">Do not check some column(s) from some table</h1><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">// skip one column
snapshot1.skipTableColumn( &quot;SomeTable1&quot;, &quot;column1&quot; );

// skip a list of column
snapshot1.skipTableColumns( &quot;SomeTable1&quot;, &quot;column1&quot;, &quot;column2&quot;, &quot;column3&quot; );
</pre>
</div></div><p> </p><hr/><h1 id="DatabaseSnapshots-Savethesnapshotintoafile">Save the snapshot into a file</h1><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">// after snapshot is taken, you can call:
snapshot1.saveToFile( &quot;C:\\db_snapshot_backup.xml&quot; );
</pre>
</div></div><div class="confluence-information-macro confluence-information-macro-tip"><span class="aui-icon aui-icon-small aui-iconfont-approve confluence-information-macro-icon"></span><div class="confluence-information-macro-body"><p>Database backup files are in XML format, so are human readable.</p></div></div><p> </p><hr/><h1 id="DatabaseSnapshots-Loadsnapshotfromfile">Load snapshot from file</h1><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">// load snapshot info from a backup file
snapshot1.loadFromFile( &quot;snapshot_from_backup_file&quot;, &quot;C:\\db_snapshot_backup.xml&quot; );
</pre>
</div></div><p> </p><hr/><h1 id="DatabaseSnapshots-Checksamedatabaseattwodifferentmoments">Check same database at two different moments</h1><p>Sometimes you do not want to compare two databases, but one and same database at different moments.</p><p>If you just go ahead, make one snapshot, then take the another snapshot in some time, you will be unpleasantly surprised both snapshots are reported identical even if there is changed content. The reason is, as we described above, in the fact we do not load the table contents prior to calling the <em>compare</em> method. So in this case when we compare each table pairs, we will actually load the tables data at same moment for both snapshots from the same database and everything will be the same.</p><p>The way to go here is to make one snapshot and save it into a file, this guarantees you get the current tables content. When the seconds snapshot is made and <em>compare</em> is called, we will compare the second snapshot tables from the database versus the first snapshot tables from the backup file.</p><p> </p><hr/><h1 id="DatabaseSnapshots-Makeyourownreportaboutthefounddifferences">Make your own report about the found differences</h1><p>If you do not like the way we present the found differences, you can make your own:</p><div class="code panel pdl" style="border-width: 1px;"><div class="codeContent panelContent pdl">
<pre class="syntaxhighlighter-pre" data-syntaxhighlighter-params="brush: java; gutter: false; theme: Confluence" data-theme="Confluence">import com.axway.ats.common.dbaccess.snapshot.DatabaseSnapshotException;
import com.axway.ats.common.dbaccess.snapshot.equality.EqualityState;

// make both snapshots as described in the previous sections of this page

try {
    // compare both snapshots
    snapshot2.compare( snapshot1 );
} catch ( DatabaseSnapshotException e ) {
    // if not expected differences are found, you will get this exception
    // you catch it here so can extract the differences out of the exception
    EqualityState equalityState = e.getEqualityState();

    // now use the available method to get the list of differences and construct your own report style
    // some of the available methods are:
    equalityState.getTablesPresentInOneSnapshotOnly( &quot;snap1&quot; );
    equalityState.getDifferentPrimaryKeys();
    equalityState.getIndexesPresentInOneSnapshotOnly( &quot;snap1&quot; );
}</pre>
</div></div><p> </p><hr/><p>Back to <a href="Basic-functionalities.html">parent page</a></p><hr/>
                    </div>

                    
                                                      
                </div>             </div> 
            <div id="footer" role="contentinfo">
                <section class="footer-body">
                    <p>Document generated by Confluence on Aug 21, 2017 08:51</p>
                    <div id="footer-logo"></div>
                </section>
            </div>
        </div>     </body>
</html>


